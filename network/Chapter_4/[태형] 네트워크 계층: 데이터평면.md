## 📚 3. 인터넷 프로토콜(IP): IPv4, 주소 지정 등
### 3.2 IPv4 데이터그램 단편화
- 링크 계층 프로토콜은 같은 크기 네트워크 계층 패킷을 전달할 수 없음
- 어떤 프로토콜은 큰 데이터그램을 전달하는 반면, 다른 프로토콜은 작은 데이터그램만을 전달 가능
    - ex. Ethernet: 최대 1500Byte, 광역 링크 프레임: 576Byte 이상 불가능
    - MTU(Maximum Transmission Unit) : 링크 계층 프레임이 전달할 수 있는 최대 데이터 양
    - MTU는 IP 데이터그램 길이에 엄격한 제약을 둔다
- 문제
    - 각 링크가 다른 링크 계층 프로토콜을 사용
    - 각 프로토콜은 서로 다른 MTU를 가짐
- 단편화(Fragmentation) : 라우터의 출력 링크가 IP 데이터그램의 길이보다 작은 MTU를 갖는다면, 더 작은 IP 데이터그램으로 분할하여 출력 링크로 보냄
- 단편화된 조각은 종단 시스템의 네트워크 계층에서 다시 결합됨
    - `식별자`, `플래그`, `단편화 오프셋` 필드를 재결합에 사용
    - 송신 호스트는 데이터그램에 `출발지 주소`, `목적지 주소` 외에도 `식별자 번호`를 헤더에 포함시킴
    - IP는 비신뢰적인 프로토콜로 모든 조각을 받는 것을 보장하지 못한다
        - 마지막 데이터그램 조각의 `플래그 비트=0`, 나머지는 `프래그 비트=1`로 설정하여 분실했는지 결정

### 3.3 IPv4주소체계
- 호스트는 인터넷에 연결되는 하나의 링크를 가짐
- 인터페이스(Interface) : 호스트와 물리적 링크 사이의 경계
- 라우터는 하나의 링크에서 데이터를 받아 다른 링크로 데이터를 넘김 -> 2개 이상의 인터페이스를 가짐
- IP는 32비트 길이로, $2^{32}$개의 주소를 사용 가능 (약 40억개)
    - IP주소의 일부는 서브넷(subnet)에 의해 결정

#### 1) 서브넷 (subnet)
- 서브넷(subnet) : 호스트들의 인터페이스들과 하나의 라우터 인터페이스로 연결된 네트워크
- 서브넷 마스크(subnet mask) : IP주소의 / 뒤에 오늘 숫자
    - ex. 223.1.1.0/24 : 24비트가 서브넷 주소를 나타냄
- 서브넷은 호스트를 라우터 인터페이스에 연결하는 이더넷 세그먼트 외에도 두 호스트를 직접 연결하는 브로드캐스트를 가짐
- 원칙적으로는 서로 다른 서브넷은 서로 다른 서브넷 주소를 가져야 하지만, 실제로 서브넷 주소는 동일한 부분이 많음

#### 2) CIDR (Classless InterDomain Routing)
- 인터넷 주소 할당 방식
- prefix : a.b.c.d/x에서 x는 IP주소의 네트워크 부분을 구성
- suffix : 네트워크 주소 뒤에 오는 주소로, 서브넷 내의 네트워크 장비의 주소를 나타냄

#### 3) Classful Addressing
- 서브넷을 A, B, C, D 클래스 네트워크로 분류
- 많은 조직에서 사용하기에는 네트워크 주소의 수가 턱없이 부족
- 하나의 서브넷이 호스트를 불필요하게 너무 많이 포함

### 3.3-2 호스트와 서브넷의 주소할당
호스트와 서브넷이 처음에 어떻게 자신의 주소를 인식하는지 알 필요가 있음
1. 주소블록을 어떻게 획득하는지
2. 획득한 주소블록의 주소를 어떻게 장비에 할당하는지

#### 1) 주소 블록 획득
1. 네트워크 관리자는 이미 할당받은 주소의 큰 블록에서 주소를 제공하는 ISP와 접촉
    - ex. ISP가 200.23.16.0/20을 할당받음
        - ISP는 블록을 작은 주소 블록 8개로 나눔
        - 8개 조직에 주소를 나누어 할당함
1-1. ISP 외에도 ICANN(Internet Corporation for Assigned Names and Numbers)에서 IP주소를 할당받을 수 있음

#### 2) 호스트 주소 획득: 동적 호스트 구성 프로토콜
2. 기관은 ISP로부터 주소 블록을 획득하여, 개별 IP주소를 기관 내부의 호스트와 라우터 인터페이스에 할당
    - 라우터 안에 IP주소를 할당
    - 일반적으로 동적 호스트 구성 프로토콜(DHCP, Dynamic Host Configuration Protocol)을 사용
    
#### 3) DHCP(Dynamic Host Configuration Protocol)
- 호스트가 네트워크에 접속할 때마다 `동일한 IP 주소`를 받거나, 다른 `임시 IP 주소`를 할당하도록 DHCP를 설정
- DHCP는 호스트 IP 주소의 할당, 서브넷 마스크, 첫 번째 홉 라우터(default gateway) 주소나 로컬 DNS 주소 등의 정보를 얻을 수 있게 함
- `플러그 앤 플레이 프로토콜(plug-and-play protocol)`, `제로 구성 프로토콜(zero-configuration protocol)`이라고도 함
- DHCP는 호스트가 빈번하게 접속하고 떠나는 `인터넷 접속 네트워크`, `엔터프라이즈 네트워크`, `무선 LAN` 등에서 폭넓게 사용됨
- 클라이언트/서버 프로토콜
- 서버가 현재 서브넷에 없다면, 해당 네트워크에 대한 DHCP 서버 주소를 알려줄 DHCP 연결 에이전트(일반적으로 라우터)가 필요

```
사용 상황
호스트가 서로 다른 네트워크에 접속할 때마다 새로운 서브넷에 접속하고, 각 서브넷에서는 새로운 IP주소를 필요로 함
```

<br>

<b>DHCP의 동작 과정</b>
1. DHCP 서버 발견(DHCP server discovery)
    - 서브넷에 새롭게 도착한 호스트는 상호동작될 DHCP 서버를 발견
    - DHCP 발견 메시지(DHCP discovery message)를 사용해 수행
    - 67번 포트로 UDP 패킷을 보냄
        - 목적지 주소 : 브로드 캐스팅(255.255.255.255)
        - 출발지 주소 : 0.0.0.0
2. DHCP 서버 제공(DHCP server offer)
    - DHCP discovery message를 받은 서버는 `DHCP 제공 메시지`를 클라이언트에게 응답
    - 동일하게 `목적지 주소 : 브로드 캐스팅`을 사용한다
    - 서브넷에는 여러 DHCP 서버가 존재하기 때문에, 클라이언트는 여러 DHCP 제공 메시지로부터 가장 최적의 위치에 존재하는 DHCP 서버를 선택
    - 서버 제공 메시지 : 수신된 `discovery message의 트랜잭션 ID`, `클라이언트에 제공된 IP주소`, `네트워크 마스크`, `IP 주소 임대 기간(주소 유효 시간)`을 포함
        - 주소 임대 기간은 보통 몇 시간 또는 며칠이 된다
3. DHCP 요청(DHCP request)
    - 새롭게 도착한 클라이언트는 하나 또는 그 이상의 서버 제공자 중에서 선택
    - 선택된 제공자에게 파라미터 설정으로 되돌아오는 `DHCP request`로 응답
4. DHCP ACK
    - 서버는 DHCP 요청 메시지에 대해 요청된 파라미터를 확인하는 `DHCP ACK 메시지`로 응답

DHCP ACK 메시지를 받으면, 상호 동작이 종료되고 클라이언트는 할당받은 IP 주소를 사용할 수 있다

### 3.4 네트워크 주소 변환(NAT, Network Address Translastion)
- SOHO(Small Office, Home Office)의 확산으로 ISP는 모든 SOHO의 IP 호스트를 수용할 수 있는 주소 범위를 할당해야 함
- NAT 가능 라우터는 홈 네트워크의 일부인 인터페이스를 가짐
- 홈 네트워크에 있는 호스트는 사설 주소를 갖는다
    - 사설 주소 권역 내 호스트들은 내부에 있는 장비끼리만 통신할 수 있고 외부 인터넷에서는 사설 주소를 사용할 수 없다
- NAT 가능한 라우터는 외부에서 라우터처럼 보이지 않고 하나의 IP주소를 갖는 장비로 동작
- 외부에서는 NAT 뒤에 있는 홈 네트워크에 대해 알 수 없음
- NAT는 DHCP와 함께 사용되며, 홈 네트워크의 주소 공간에서 DHCP 서버를 실행하여 호스트들에게 주소를 할당함
- NAT 변환 테이블(NAT translation table)을 통해 외부 네트워크와 홈 네트워크가 통신
    - 홈 네트워크의 출발 호스트가 임의의 출발지 포트 번호를 할당(ex. 3345)하고 출발지로 요청
    - 라우터는 데이터그램을 받아, 새로운 출발지 포트 번호를 할당(ex. 5001)
    - 목적지 호스트는 NAT에 의해 변환된 출발지 포트 번호(ex. 5001)로 응답
    - NAT 변환 테이블은 응답을 받아 다시 출발 호스트의 출발지 포트 번호(ex. 3345)로 변환하여 홈 네트워크의 호스트로 전달